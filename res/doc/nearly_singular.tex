\chapter{Nearly singular integrals}
\label{sec:nearly_singular}

\section{Collocational nearly singular integrals}

\subsection{3D Laplace kernel}

\subsubsection{Planar elements with constant $N$-set}

\paragraph{SLP kernel}

\begin{multline}
	\int_E G({\bf x}, {\bf y}) \td {\bf y}
	= \int_E \frac{1}{4\pi |{\bf x} - {\bf y}|} \td {\bf y}
	= \frac{1}{4\pi} \oint_{\theta} \int_{0}^{\bar{R}(\theta)} \frac{1}{\sqrt{z^2 + R^2}} R \td R \td \theta
	\\
	= \frac{1}{4\pi} \oint_{\theta} \left[ \sqrt{z^2 + R^2} \right]_{0}^{\bar{R}(\theta)} \td \theta
	= \frac{1}{4\pi} \oint_{\theta} \left( \bar{r}(\theta) - |z| \right) \td \theta
\end{multline}

\paragraph{DLP kernel}

\begin{multline}
	\int_E G'_{n_y}({\bf x}, {\bf y}) \td {\bf y}
	= \frac{1}{4\pi} \int_E \frac{-1}{r^2} \frac{{\bf r} \cdot {\bf n}_y}{r} \td {\bf y}
	= \frac{1}{4\pi} \int_E \frac{z}{r^3} \td {\bf y}
	\\
	= \frac{1}{4\pi} \oint_{\theta} \int_{0}^{\bar{R}(\theta)} \frac{1}{4\pi} \int_E \frac{z}{\sqrt{z^2 + R^2}^3} R \td R \td \theta
	= \frac{1}{4\pi} \oint_{\theta} \left[ \frac{-z}{\sqrt{z^2 + R^2}} \right]_{0}^{\bar{R}(\theta)} \td \theta \\
	= \frac{1}{4\pi} \oint_{\theta} \left( \frac{-z}{\bar{r}} + \frac{z}{|z|} \right) \td \theta
	= \frac{\sgn(z)}{4\pi} \oint_{\theta} \left( 1 - \frac{|z|}{\bar{r}} \right) \td \theta
\end{multline}

\paragraph{DLPt kernel}

\begin{multline}
	\int_E G'_{n_x}({\bf x}, {\bf y}) \td {\bf y}
	= \frac{1}{4\pi} \int_{E} \frac{-1}{r^2} \frac{-{\bf r} \cdot {\bf n}_x }{r} \td {\bf y} \\
	= \frac{1}{4\pi} \oint_{\theta} \int_{0}^{\bar{R}(\theta)} \frac{R^2 (\cos\theta n_x + \sin\theta n_y) - R z n_z }{\sqrt{R^2 + z^2}^3}
	\td R \td \theta
	\\
	= \frac{1}{4\pi} \oint_{\theta} \left\{
	\left[ \log (r + R) - \frac{R}{r}\right]_{0}^{\bar{R}} (\cos\theta n_x + \sin\theta n_y)
	+ \left[ \frac{z n_z}{r} \right]_{0}^{\bar{R}}
	\right\} \td \theta
	\\
	= \frac{1}{4\pi} \oint_{\theta} \left\{
	\left(\log \frac{\bar{r} + \bar{R}}{|z|} - \frac{\bar{R}}{\bar{r}} \right) (\cos\theta n_x + \sin\theta n_y)
	+ (\frac{z n_z}{\bar{r}} - \frac{z n_z}{|z|})
	\right\} \td \theta
	\\
	= \frac{1}{4\pi} \oint_{\theta} \left\{
	\log \frac{\bar{r} + \bar{R}}{|z|}(\cos\theta n_x + \sin\theta n_y) - \frac{\bar{\bf r} \cdot {\bf n}_x}{\bar{r}} 
	- \frac{z n_z}{|z|}
	\right\} \td \theta
\end{multline}

\paragraph{HSP kernel}

\begin{multline}
	\int_E
		G''_{n_x n_y}({\bf x}, {\bf y})
	\td {\bf y}
	=
	\frac{1}{4\pi}
	\int_E 
	\left(
		\frac{-{\bf n}_x {\bf r}}{r} \frac{{\bf n}_y {\bf r}}{r} \frac{3}{r^3}
		+
		\frac{{\bf n}_x {\bf n}_y}{r^3}
	\right) \td{\bf y}
	= \\
	\frac{1}{4\pi}
	\oint_\theta \int_0^{\bar{R}} 
	\left(
		\frac{-n_x R \cos\theta - n_y R \sin\theta + n_z z}{r} \frac{-z}{r} \frac{3}{r^3}
		+
		\frac{n_z}{r^3}
	\right) R \td R \td\theta
	= \\
	\frac{1}{4\pi}
	\oint_\theta
		\frac{R^2 {\bf n}_x {\bf r}}{z r^3}
	\td\theta
	=
	\frac{1}{4\pi}
	\oint_\theta
		-\left(\frac{R}{r}\right)^2 \frac{r'_{n_x}}{z}
	\td\theta
\end{multline}
%
For the $z=0$ case
%
\begin{equation}
	\int_E
		G''_{n_x n_y}({\bf x}, {\bf y})
	\td {\bf y}
	=
	\frac{1}{4\pi}
	\oint_\theta \int_0^{\bar{R}} 
	\left(
		\frac{n_z}{R^3}
	\right) R \td R \td\theta
	= 
	\frac{1}{4\pi}
	\oint_\theta
	\left(
		\frac{-n_z}{R}
	\right)
	\td\theta
\end{equation}


\subsubsection{General method with Stokes' theorem}

\paragraph{HSP kernel}

\begin{equation}
	I = \int_E G''_{n_x n_y}({\bf x}, {\bf y}) N({\bf y}) \td {\bf y}
\end{equation}
%
Let ${\bf x}_c$ denote the projection of the singular point ${\bf x}$ on the boundary surface.
The shape function ${\bf N}({\bf y})$ is expanded into a Taylor series around the projection point:
%
\begin{equation}
	N({\bf y}) = N({\bf x}_c) - \nabla N({\bf x}_c) ({\bf y} - {\bf x}_c) + O(\rho^2)
\end{equation}
%
By adding and subtracting the linear Taylor series to the shape function, the integral is split up into three parts as follows:
%
\begin{multline}
	I = \underbrace{\int_E G''_{n_x n_y}({\bf x}, {\bf y})
	\left[ N({\bf y}) - N({\bf x}_c) - \nabla N({\bf x}_c) ({\bf y} - {\bf x}_c)\right]
	\td {\bf y}}_{\text{weakly singular}} \\
	+
	N({\bf x}_c)
	\underbrace{\int_E G''_{n_x n_y}({\bf x}, {\bf y})
	\td {\bf y}}_{I_0}
	+
	\nabla N({\bf x}_c)
	\underbrace{\int_E G''_{n_x n_y}({\bf x}, {\bf y})
	({\bf y} - {\bf x}_c)
	\td {\bf y}}_{{\bf I}_1}
\end{multline}
%
The bracketed term in the first integral is $O(\rho^2)$.
As a consequence, the first integral is weakly singular, and can be computed using a standard polar coordinate transform (Duffy quadratures).
The remaining integrals $I_0$ and ${\bf I}_1$ are transformed into contour integrals using Stokes' theorem.
The resulting formulas read as (see their derivation in the appendix \ref{sec:stokes_laplace_hsp})
%
\begin{align}
	N({\bf x}_c) I_0 =
	&
	N({\bf x}_c) \oint_C
	\left< {\bf n}({\bf x}), \nabla G({\bf x}, {\bf y}) , \td {\bf y} \right> \\
	{\nabla N}({\bf x}_c) \cdot {\bf I}_{1} =
	& 
	\oint_C
	\left( \nabla N({\bf x}_c) \cdot ({\bf y} - {\bf x}_c) \right)
	\left< {\bf n}({\bf x}) , \nabla G({\bf x}, {\bf y}) , \td {\bf y} \right> \\
	&
	-
	\oint_C
	G({\bf x}, {\bf y})
	\left< {\bf n}({\bf x}), \nabla N({\bf x}_c), \td {\bf y} \right>
	\\
	&
	+
	\int_E
	G'_{n_x}({\bf x}, {\bf y})
	\left(\nabla N({\bf x}_c) \cdot {\bf n}({\bf y})\right)
	\td S({\bf y}) \\
	&
	-
	\left( \nabla N({\bf x}_c) {\bf n}({\bf x}) \right)
	\frac{\Omega({\bf x})}{4\pi}
\end{align}
%
where $C$ denotes the contour of $E$, and $<{\bf a}, {\bf b}, {\bf c}>$ denotes the triple product ${\bf a} \cdot {\bf b} \times {\bf c}$, and $\Omega({\bf x})$ is the solid angle subtended by element $E$ from the source point.
